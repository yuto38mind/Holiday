<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Holiday Letter</title>
<style>
  :root{
    --bg1:#0b1020; --bg2:#1a2444;
    --card: rgba(10,14,28,.45);
    --border: rgba(255,255,255,.14);
    --shadow: 0 18px 50px rgba(0,0,0,.35);
    --text:#fff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;
    background:linear-gradient(var(--bg1),var(--bg2));
    color:var(--text);
    overflow:hidden;
  }
  .scene{
    position:relative;
    width:100%;
    height:100vh;
    height:100dvh;
  }

  /* ===== æ¡œï¼ˆèŠ±ã³ã‚‰ï¼‰ ===== */
  .petals{
    position:absolute; inset:0;
    pointer-events:none;
    overflow:hidden;
  }
  .petal{
    position:absolute;
    top:-10vh;
    width:14px; height:10px;
    background: radial-gradient(circle at 30% 30%, #ffd1dc 0%, #ffb7c5 35%, #ff9fb2 70%, #ff8aa2 100%);
    border-radius: 80% 20% 80% 20%;
    transform: rotate(15deg);
    opacity:.75;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,.25));
    animation:
      fall var(--fallDur) linear var(--delay) infinite,
      sway var(--swayDur) ease-in-out var(--delay) infinite,
      spin var(--spinDur) ease-in-out var(--delay) infinite;
  }
  @keyframes fall{
    from{ transform: translate(var(--x0), -10vh) rotate(0deg); }
    to  { transform: translate(var(--x1), 110vh) rotate(360deg); }
  }
  @keyframes sway{
    0%,100%{ margin-left: 0 }
    50%{ margin-left: var(--sway) }
  }
  @keyframes spin{
    0%,100%{ rotate: 10deg }
    50%{ rotate: -18deg }
  }
  @media (prefers-reduced-motion: reduce){
    .petal{ display:none; }
  }

  /* ===== å†™çœŸã‚·ãƒ¼ã‚±ãƒ³ã‚¹ ===== */
  .stack{
    position:absolute;
    left:50%;
    top:14vh;
    transform: translateX(-50%);
    width:min(920px,92vw);
    display:flex;
    gap:14px;
    justify-content:center;
    align-items:stretch;
  }
  .photo{
    flex:1;
    min-width:0;
    aspect-ratio: 3 / 4;
    border-radius:18px;
    background: var(--card);
    border:1px solid var(--border);
    box-shadow: var(--shadow);
    overflow:hidden;
    opacity:0;
    transform: translateY(12px);
    transition: opacity .9s ease, transform .9s ease;
    will-change: opacity, transform;
    position:relative;
  }
  .photo.show{
    opacity:1;
    transform: translateY(0);
  }
  .photo.hide{
    opacity:0;
    transform: translateY(16px);
  }
  .photo img{
    width:100%; height:100%;
    object-fit: cover;
    display:block;
    filter: saturate(1.05) contrast(1.02);
  }

  .photo .toko{
    position:absolute;
    right: 14px;
    bottom: 14px;
    padding: 8px 12px;
    border-radius: 999px;
    font-weight: 800;
    letter-spacing: .06em;
    background: rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.18);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    opacity: 0;
    transform: translateY(6px);
    transition: opacity .6s ease, transform .6s ease;
  }
  .photo.show .toko{
    opacity: 1;
    transform: translateY(0);
  }
  .photo.hide .toko{
    opacity: 0;
    transform: translateY(8px);
  }

  .photo::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to top, rgba(0,0,0,.28), transparent 50%);
    pointer-events:none;
  }

  /* ===== å°ç­’ï¼ˆæ‰‹ç´™ï¼‰ ===== */
  .letterWrap{
    position:absolute;
    left:50%;
    bottom:10vh;
    transform: translateX(-50%);
    width:min(520px,90vw);
    display:flex;
    justify-content:center;
    opacity:0;
    transform-origin:center;
    transition: opacity .8s ease, transform .8s cubic-bezier(.2,.8,.2,1);
  }
  .letterWrap.show{
    opacity:1;
    transform: translateX(-50%) translateY(0);
  }
  .envelope{
    width:100%;
    aspect-ratio: 16 / 10;
    position:relative;
    cursor:pointer;
    user-select:none;
    border-radius:22px;
    box-shadow: var(--shadow);
    outline:none;
  }
  .env-back{
    position:absolute; inset:0;
    background: rgba(255,255,255,.10);
    border: 1px solid var(--border);
    border-radius:22px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .env-front{
    position:absolute; inset:0;
    border-radius:22px;
    overflow:hidden;
  }
  .env-front:before{
    content:"";
    position:absolute; inset:0;
    background:
      linear-gradient(135deg, transparent 50%, rgba(255,255,255,.12) 50%) left,
      linear-gradient(-135deg, transparent 50%, rgba(255,255,255,.12) 50%) right;
    background-size: 50% 100%;
    background-repeat:no-repeat;
    border:1px solid var(--border);
    border-radius:22px;
  }
  .seal{
    position:absolute;
    left:50%; top:55%;
    transform: translate(-50%,-50%);
    width:64px; height:64px;
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, #ffdee7, #ffb7c5 70%, #ff95ae);
    border:1px solid rgba(255,255,255,.25);
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
    display:grid;
    place-items:center;
    font-weight:800;
    letter-spacing:.08em;
    color:#3a1420;
  }
  .hint{
    position:absolute;
    left:50%;
    top:10%;
    transform:translateX(-50%);
    font-weight:700;
    opacity:.92;
    text-align:center;
    width:90%;
  }
  .hint small{display:block; opacity:.75; font-weight:600; margin-top:.25em}

  /* é–‹å°å¾Œã®ç´™ */
  .paper{
    position:absolute;
    left:50%; top:18%;
    transform: translateX(-50%) translateY(18px);
    width:90%;
    height:72%;
    background: rgba(255,255,255,.92);
    color:#111;
    border-radius:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,.25);
    padding: 18px 18px;
    opacity:0;
    pointer-events:none;
    transition: opacity .55s ease, transform .55s ease;
    overflow:auto;
  }
  .paper.show{
    opacity:1;
    transform: translateX(-50%) translateY(0);
    pointer-events:auto;
  }
  .paper h1{
    margin:0 0 10px 0;
    font-size: clamp(18px, 3.8vw, 24px);
  }
  .paper .text{
    font-size: clamp(16px, 3.4vw, 20px);
    line-height:1.7;
    white-space:pre-wrap;
  }
  .paper .close{
    position:sticky;
    bottom:0;
    margin-top:14px;
    display:flex;
    justify-content:center;
  }
  .paper button{
    border:0;
    padding:10px 14px;
    border-radius:999px;
    background:#111;
    color:#fff;
    font-weight:700;
    cursor:pointer;
  }

  .envelope:focus-visible{
    outline: 3px solid rgba(255,255,255,.35);
    outline-offset: 4px;
  }
</style>
</head>
<body>
<div class="scene" id="scene">
  <div class="petals" id="petals" aria-hidden="true"></div>

  <div class="stack" aria-label="å†™çœŸã‚¹ãƒ©ã‚¤ãƒ‰">
    <div class="photo" id="p1">
      <img src="assets/photo1.jpg" alt="photo 1">
      <div class="toko">ãƒˆã‚³ãƒˆã‚³</div>
    </div>

    <div class="photo" id="p2">
      <img src="assets/photo2.jpg" alt="photo 2">
      <div class="toko">ãƒˆã‚³ãƒˆã‚³</div>
    </div>

    <div class="photo" id="p3">
      <img src="assets/photo3.jpg" alt="photo 3">
      <div class="toko">ãƒˆã‚³ãƒˆã‚³</div>
    </div>
  </div>

  <div class="letterWrap" id="letterWrap">
    <div class="envelope" id="envelope" role="button" tabindex="0" aria-label="æ‰‹ç´™ã‚’é–‹ã">
      <div class="env-back"></div>
      <div class="env-front"></div>
      <div class="seal">OPEN</div>
      <div class="hint" id="hint">
        æ‰‹ç´™ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é–‹ã„ã¦ã­
        <small>Enter / Space ã§ã‚‚OK</small>
      </div>

      <div class="paper" id="paper" aria-live="polite">
        <h1 id="paperTitle">Message</h1>
        <div class="text" id="paperText"></div>
        <div class="close"><button type="button" id="closeBtn">é–‰ã˜ã‚‹</button></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== å¥½ãã«æ›¸ãæ›ãˆã‚‹å ´æ‰€ =====
  const MESSAGE = "ğŸ‰ ã‚ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ï¼\n\nä»Šå¹´ã‚‚ã©ã†ãã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚\nå¥åº·ã§è‰¯ã„ä¸€å¹´ã«ãªã‚Šã¾ã™ã‚ˆã†ã«ã€‚";
  const SIGN    = "â€” K ã‚ˆã‚Š"; // ä¸è¦ãªã‚‰ ""
  const TITLE   = "New Year Letter";
  const PHOTO_DELAY = 2000;   // å†™çœŸãŒå‡ºã‚‹é–“éš”ï¼ˆmsï¼‰
  const VISIBLE_MS  = 2200;   // è¡¨ç¤ºã—ã¦ã„ã‚‹æ™‚é–“ï¼ˆmsï¼‰
  const PETAL_COUNT = 26;     // èŠ±ã³ã‚‰é‡ï¼ˆç«¯æœ«ãŒé‡ã‘ã‚Œã°ä¸‹ã’ã‚‹ï¼‰
  // ===============================

  // æ¡œã‚’ç”Ÿæˆï¼ˆè»½é‡ï¼‰
  const petals = document.getElementById("petals");
  if(!matchMedia("(prefers-reduced-motion: reduce)").matches){
    for(let i=0;i<PETAL_COUNT;i++){
      const p=document.createElement("div");
      p.className="petal";
      const x0 = Math.random()*100;
      const x1 = x0 + (Math.random()*30-15);
      const sway = (Math.random()*24-12) + "px";
      p.style.setProperty("--x0", x0+"vw");
      p.style.setProperty("--x1", x1+"vw");
      p.style.setProperty("--sway", sway);
      p.style.setProperty("--fallDur", (10+Math.random()*9)+"s");
      p.style.setProperty("--swayDur", (2.6+Math.random()*2.4)+"s");
      p.style.setProperty("--spinDur", (2.8+Math.random()*2.6)+"s");
      p.style.setProperty("--delay", (-Math.random()*10)+"s");
      p.style.opacity = (0.45 + Math.random()*0.4).toFixed(2);
      p.style.transform = `scale(${(0.7+Math.random()*1.2).toFixed(2)})`;
      petals.appendChild(p);
    }
  }

  // å†™çœŸï¼šè¦ç´ å–å¾—
  const p1 = document.getElementById("p1");
  const p2 = document.getElementById("p2");
  const p3 = document.getElementById("p3");
  const letterWrap = document.getElementById("letterWrap");

  // åˆæœŸåŒ–
  [p1,p2,p3].forEach(el => el.classList.remove("show","hide"));

  function showThenHide(el, showDelay, visibleMs = VISIBLE_MS){
    setTimeout(() => {
      el.classList.add("show");
      el.classList.remove("hide");
    }, showDelay);

    setTimeout(() => {
      el.classList.add("hide");
      el.classList.remove("show");
    }, showDelay + visibleMs);
  }

  // å³ã‹ã‚‰é †ã«è¡¨ç¤ºï¼šp3 â†’ p2 â†’ p1
  showThenHide(p3, 200);
  showThenHide(p2, 200 + PHOTO_DELAY);
  showThenHide(p1, 200 + PHOTO_DELAY*2);

  // æ‰‹ç´™ã¯æœ€å¾Œã«å‡ºã™
  setTimeout(() => letterWrap.classList.add("show"), 200 + PHOTO_DELAY*3);

  // æ‰‹ç´™ï¼šé–‹å°
  const envelope = document.getElementById("envelope");
  const paper = document.getElementById("paper");
  const paperText = document.getElementById("paperText");
  const paperTitle = document.getElementById("paperTitle");
  const closeBtn = document.getElementById("closeBtn");
  const hint = document.getElementById("hint");

  paperTitle.textContent = TITLE;

  const fullText = SIGN ? (MESSAGE + "\n\n" + SIGN) : MESSAGE;

  function typewriter(el, text, ms=18){
    el.textContent = "";
    let i = 0;
    const id = setInterval(() => {
      el.textContent = text.slice(0, ++i);
      if(i >= text.length) clearInterval(id);
    }, ms);
    return id;
  }

  let opened = false;
  let typingId = null;

  function openLetter(){
    if(opened) return;
    opened = true;
    hint.style.display = "none";
    paper.classList.add("show");
    typingId = typewriter(paperText, fullText, 18);
  }

  function closeLetter(){
    opened = false;
    if(typingId) clearInterval(typingId);
    paper.classList.remove("show");
    hint.style.display = "";
    paperText.textContent = "";
  }

  envelope.addEventListener("click", (e) => {
    if(e.target.closest("#paper")) return; // ç´™ä¸Šã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
    if(!opened) openLetter();
  });

  envelope.addEventListener("keydown", (e) => {
    if(e.key === "Enter" || e.key === " "){
      e.preventDefault();
      if(!opened) openLetter();
    }
    if(e.key === "Escape" && opened){
      closeLetter();
    }
  });

  closeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    closeLetter();
  });
</script>
</body>
</html>
